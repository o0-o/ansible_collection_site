---
# vim: ts=2:sw=2:sts=2:et:ft=yaml.ansible
#
# Configure site inventory on localhost
#
########################################################################

- name: Get collection metadata
  ansible.builtin.include_vars:
    file: "{{ role_path | dirname | dirname }}/galaxy.yml"
    name: site_collection

- name: Define default comment header
  ansible.builtin.set_fact:
    default_comment_header: |
      Generated by the o0_o.site collection {{site_collection['version']}}

      Some or all of this file is managed by Ansible. Changes may be
      overwritten (see below).

- name: Define site
  ansible.builtin.include_tasks: site.yml

- name: "Create {{inv_dir_var}}"
  ansible.builtin.file:
    path: "{{inv_dir_var}}"
    state: directory
    mode: 0755
  delegate_to: 127.0.0.1
  vars:
    inv_dir_var: "{{cwd}}/inventory"

- name: "Create {{hv_dir_var}}"
  ansible.builtin.file:
    path: "{{hv_dir_var}}"
    state: directory
    mode: 0755
  delegate_to: 127.0.0.1
  vars:
    hv_dir_var: "{{cwd}}/inventory/host_vars"

- name: "Create {{gv_dir_var}}"
  ansible.builtin.file:
    path: "{{gv_dir_var}}"
    state: directory
    mode: 0755
  delegate_to: 127.0.0.1
  vars:
    gv_dir_var: "{{cwd}}/inventory/group_vars"

- name: "Initialize {{inv_var}}"
  ansible.builtin.template:
    src: site_inv.yml.j2
    dest: "{{inv_var}}"
    force: no
  delegate_to: 127.0.0.1
  vars:
    inv_var: "{{cwd}}/inventory/{{site['name']}}.{{site['etld']}}.yml"

- name: "Initialize {{gv_all_var}}"
  ansible.builtin.template:
    src: all.yml.j2
    dest: "{{gv_all_var}}"
    force: no
  delegate_to: 127.0.0.1
  vars:
    gv_all_var: "{{cwd}}/inventory/group_vars/all.yml"

- name: "Initialize {{gv_site_var}}"
  ansible.builtin.template:
    src: site_group_vars.yml.j2
    dest: "{{gv_site_var}}"
    force: no
  delegate_to: 127.0.0.1
  vars:
    gv_site_var: "{{cwd}}/inventory/group_vars\
      /{{site['name']}}_{{ site['etld'] | regex_replace('\\.', '_') }}.yml"

- name: Initialize host variables file if it doesn't exist
  ansible.builtin.template:
    src: host_vars.yml.j2
    dest: "{{cwd}}/inventory/host_vars\
      /{{ update_hostname | default(inventory_hostname) }}.yml"
    force: false
  delegate_to: 127.0.0.1
